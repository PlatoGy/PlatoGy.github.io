---
layout: post
title: æ€§èƒ½ä¼˜åŒ–PPT7
author: Patrick Gao
date: 2025-03-29 21:00
categories:
  - MISCADA
  - GPU Course
tags:
  - GPU Programming
mermaid: true
math: true
pin: false
---

# ğŸ“š Session 6: Cache Blocking & Tiling  
_Anne Reinarz_

---

## ğŸ§® Matrix Transpose (åŸºç¡€)

**ç›®æ ‡ï¼š** è®¡ç®—è½¬ç½®çŸ©é˜µ  
ç»™å®šä¸¤ä¸ª NÃ—N çš„çŸ©é˜µ A å’Œ Bï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

```c
B[i*N + j] = A[j*N + i];
```

### ğŸ” ç®€å•æ€§èƒ½æ¨¡å‹ï¼š

- **NÂ² æ¬¡å­˜å‚¨ï¼ˆstoreï¼‰**
- **NÂ² æ¬¡åŠ è½½ï¼ˆloadï¼‰**
- **æ— è®¡ç®—æ“ä½œ**

---

## ğŸ§  Loads vs. Stores

- ç¼“å­˜å±€éƒ¨æ€§å¯¹ loads å’Œ stores çš„å½±å“ä¸åŒï¼š
  - **Loads**ï¼šæé«˜ cache hit ç‡
  - **Stores**ï¼šæ¶‰åŠç¼“å­˜ä¸€è‡´æ€§ï¼ˆcache coherenceï¼‰ä¸å†™å…¥ç­–ç•¥ï¼ˆwriting policyï¼‰

ğŸ”— å‚è€ƒèµ„æ–™ï¼š
- [Cache coherence](https://en.wikipedia.org/wiki/Cache_coherence)
- [Writing policies](https://en.wikipedia.org/wiki/Cache_(computing)#Writing_policies)
- [Non-temporal stores](https://vgatherps.github.io/2018-09-02-nontemporal/)

---

## ğŸ“Š æ€§èƒ½æ•°æ®ï¼šå¸¦å®½ [GB/s]

| Matrix Size | Bandwidth |
|-------------|-----------|
| 128Ã—128     | 22        |
| 256Ã—256     | 13        |
| 512Ã—512     | 13        |
| 1024Ã—1024   | 5         |
| 2048Ã—2048   | 1.6       |
| 4096Ã—4096   | 0.9       |

ğŸ“‰ **é—®é¢˜ï¼š** `A[j*N + i]` æ˜¯ stride-N è®¿é—®ï¼Œè®¿é—®æ¨¡å¼ä¸åˆ©äºç¼“å­˜

---

## ğŸ“ ç¼“å­˜å±€éƒ¨æ€§åˆ†æ

- è¡Œä¸»åºå­˜å‚¨ï¼Œcache line å¤§å°ä¸º L
- è¯»å– A æ—¶ä½¿ç”¨çš„æ˜¯è·¨è¡Œè®¿é—®ï¼ˆstride-Nï¼‰
- æƒ³è¦å……åˆ†åˆ©ç”¨ cacheï¼Œéœ€è¦è¿›è¡Œè®¿é—®é‡æ’

---

## ğŸ’¡ æ”¹è¿›æ€è·¯ï¼šBlock + Loop Reordering

**æ ¸å¿ƒæ–¹æ³•ï¼š**
1. **Strip mining**ï¼ˆåˆ†å—éå†ï¼‰
2. **Loop reordering**ï¼ˆé‡æ’è¿­ä»£é¡ºåºï¼‰

---

## ğŸ”§ Strip Mining ç¤ºä¾‹ï¼ˆå•å±‚å¾ªç¯ï¼‰

```c
for (int ii = 0; ii < N; ii += stride)
    for (int i = ii; i < min(N, ii + stride); i++)
        A[i] = f(i);
```

é€‚ç”¨äºåµŒå¥—å¾ªç¯ï¼Œæ”¹å–„å†…å­˜è®¿é—®æ¨¡å¼

---

## ğŸ” Strip Mining åµŒå¥—å¾ªç¯ï¼ˆåŸå§‹ â†’ æ”¹è¿›ï¼‰

**åŸå§‹ä»£ç ï¼š**

```c
for (int i = 0; i < N; i++)
    for (int j = 0; j < N; j++)
        B[i*N + j] = A[j*N + i];
```

**æ”¹è¿›åï¼š**

```c
for (int ii = 0; ii < N; ii += stridei)
    for (int i = ii; i < min(N, ii + stridei); i++)
        for (int jj = 0; jj < N; jj += stridej)
            for (int j = jj; j < min(N, jj + stridej); j++)
                B[i*N + j] = A[j*N + i];
```

---

## ğŸ” Loop Reorderingï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰

è°ƒæ¢ `i` å’Œ `jj` çš„é¡ºåºï¼š

```c
for (int ii = 0; ii < N; ii += stridei)
    for (int jj = 0; jj < N; jj += stridej)
        for (int i = ii; i < min(N, ii + stridei); i++)
            for (int j = jj; j < min(N, jj + stridej); j++)
                B[i*N + j] = A[j*N + i];
```

âœ… æ”¯æŒé’ˆå¯¹ **L1/L2/L3 cache** è°ƒæ•´ tile size  
âš ï¸ å¢åŠ äº†ä¸€å®šçš„é€»è¾‘å¼€é”€

---

## ğŸ“ˆ å¯¹æ¯”å›¾ç¤º

- B çš„è¿­ä»£è®¿é—®ï¼šbefore vs. after  
- A çš„è¿­ä»£è®¿é—®ï¼šbefore vs. after  
- Tiled B vs. Tiled A æ€§èƒ½å¯¹æ¯”

---

## ğŸ§ª Exercise 7: å®è·µ Tiled Matrix Transpose

1. åˆ†ç»„è¿›è¡Œç»ƒä¹   
2. ä¸‹è½½ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç   
3. æµ‹é‡ä¸åŒçŸ©é˜µå¤§å°ä¸‹çš„å¸¦å®½  
4. å°è¯•ä¸åŒçš„ tile size  
5. ç§¯ææé—®ï¼
