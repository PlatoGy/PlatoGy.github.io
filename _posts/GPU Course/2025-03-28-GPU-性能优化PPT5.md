---
layout: post
title: æ€§èƒ½ä¼˜åŒ–PPT5
author: Patrick Gao
date: 2025-03-28 19:00
categories:
  - MISCADA
  - GPU Course
tags:
  - GPU Programming
mermaid: true
math: true
pin: false
---

# Lecture 5ï¼šPerformance Measurements

## ğŸ¯ æœ¬è®²ç›®æ ‡ï¼šRoofline åˆ†æ & æ€§èƒ½æµ‹é‡

---

## ğŸ§  Exercise 4ï¼šRoofline for Matrix-Vector Multiply

ç›®æ ‡è®¡ç®—ï¼š
$$
y = Ax = \sum_{j=1}^{n_{col}} A_{ij}x_j
$$

---

## ğŸŒ„ Roofline æ¨¡å‹æ¦‚è¿°

- ç”¨äº**ä¸åŒç¡¬ä»¶é…ç½®çš„å¯¹æ¯”**
- æä¾›ä»£ç æ€§èƒ½çš„**é«˜å±‚æ¬¡æ¦‚è§ˆ**
- ç»™å‡º**ä¼˜åŒ–æ–¹å‘çš„å»ºè®®**

---

## ğŸ” Performance Measurements ä½œç”¨

- è·å–æ›´å¤šå…³äº**æ€§èƒ½ç“¶é¢ˆ**çš„ä¿¡æ¯
- ç”¨äºéªŒè¯é€šè¿‡ roofline åˆ†æå½¢æˆçš„**æ€§èƒ½å‡è®¾**

---

## ğŸ› ï¸ æ€§èƒ½æµ‹é‡æ‰‹æ®µ

### ä½¿ç”¨**ç‰¹æ®Šå¯„å­˜å™¨ï¼ˆPerformance Countersï¼‰**

ç°ä»£ç¡¬ä»¶ä¸­å¸¸è§ï¼Œç”¨äºè®°å½•åº•å±‚æ€§èƒ½äº‹ä»¶ï¼š

- ä¸åŒç±»å‹çš„ FLOPsï¼ˆæ ‡é‡ã€SSEã€AVXï¼‰
- å¤šçº§ç¼“å­˜çš„ miss/hit æ•°é‡
- åˆ†æ”¯é¢„æµ‹çš„æˆåŠŸç‡
- ...

âš ï¸ æ³¨æ„ï¼š
- ä¿¡æ¯**åºæ‚å¤æ‚**
- æœ€å¥½ç”¨äºéªŒè¯æ¨¡å‹ä¸­æå‡ºçš„**æ€§èƒ½ç“¶é¢ˆå‡è®¾**

---

## âš ï¸ Caveatsï¼ˆæ³¨æ„äº‹é¡¹ï¼‰

è¿™äº›æµ‹é‡æä¾›çš„æ˜¯ï¼š

- å®é™…å®ç°çš„ç®—æ³•çš„ä¿¡æ¯
- å®ç°æ–¹å¼çš„ä¿¡æ¯
- å½“å‰è¿è¡Œä¸­å®é™…ç§»åŠ¨çš„æ•°æ®

ä½†å®ƒ**ä¸ä¼šè€ƒè™‘**ï¼š

- å¯èƒ½æ›´å¥½çš„ç®—æ³•
- æ›´ä¼˜çš„å®ç°æ–¹å¼
- ä¸åŒè¿è¡Œä¸­å¯èƒ½ç§»åŠ¨çš„æ•°æ®

ğŸ”‘ å› æ­¤ï¼š**ä»…å¯ä½œä¸ºæ€§èƒ½æ¨¡å‹çš„è¡¥å……æ‰‹æ®µ**

---

## ğŸ”¬ Granularityï¼ˆç²’åº¦ï¼‰

### 1. ç›´æ¥è¯»å–ç¡¬ä»¶è®¡æ•°å™¨

- æœ€è¯¦ç»†
- ä¸ç¡¬ä»¶å¼ºç›¸å…³ï¼Œ**ä¸å¯ç§»æ¤**

### 2. æŠ½è±¡æŒ‡æ ‡

- å°†åº•å±‚è®¡æ•°å™¨åˆ†ç»„
- æ›´é€‚åˆè·¨ç¡¬ä»¶æ¯”è¾ƒ  
  ä¾‹å¦‚ï¼š `instructions` â†’ `instructions per cycle`

---

## ğŸ§ª å¦‚ä½•æµ‹é‡ï¼Ÿï¼ˆToolsï¼‰

ä½¿ç”¨ [`likwid-perfctr`](https://github.com/RRZE-HPC/likwid)ï¼š

- åœ¨ Hamilton é›†ç¾¤ä¸Šé€šè¿‡ `likwid` æ¨¡å—æä¾›
- å‘½ä»¤è¡Œå·¥å…·ï¼Œä½¿ç”¨å‹å¥½
- å¯è®¿é—®åŸå§‹è®¡æ•°å™¨ & å¸¸ç”¨é¢„è®¾æŒ‡æ ‡ç»„

ğŸ“Œ æˆ‘ä»¬ä¼šç”¨ `likwid-perfctr` æ¥å¯¹æ¯”ä¸åŒå®ç°ä¸­ memory reference çš„æ•°é‡

---

## ğŸ’» ç¤ºä¾‹ï¼šSTREAM TRIAD

### Scalar å®ç°

```c
for i = 0 to n:
  reg1 = load a[i]
  reg2 = load b[i]
  reg4 = load c[i]
  reg3 = reg1 * reg2
  reg4 = reg3 + reg4
  store c[i] = reg4
```

### SSE å®ç°ï¼ˆæ¯æ¬¡å¤„ç† 2 ä¸ªï¼‰

```c
for i = 0 to n by 2:
  vreg1 = vload a[i:i+2]
  vreg2 = vload b[i:i+2]
  vreg4 = vload c[i:i+2]
  vreg3 = vmul vreg1, vreg2
  vreg4 = vadd vreg3, vreg4
  vstore c[i:i+2] = vreg4
```

### AVX å®ç°ï¼ˆæ¯æ¬¡å¤„ç† 4 ä¸ªï¼‰

```c
for i = 0 to n by 4:
  vreg1 = vload a[i:i+4]
  vreg2 = vload b[i:i+4]
  vreg4 = vload c[i:i+4]
  vreg3 = vmul vreg1, vreg2
  vreg4 = vadd vreg3, vreg4
  vstore c[i:i+4] = vreg4
```

### AVX2 å®ç°ï¼ˆä½¿ç”¨ fused multiply-addï¼‰

```c
for i = 0 to n by 4:
  vreg1 = vload a[i:i+4]
  vreg2 = vload b[i:i+4]
  vreg3 = vload c[i:i+4]
  vreg3 = vfma vreg1, vreg2, vreg3
  vstore c[i:i+4] = vreg3
```

---

## ğŸ“Š æ¨¡å‹åˆ†æ

å¯¹äº $N = 10^6$ï¼Œæ¯è½®å¾ªç¯æœ‰ï¼š

- 3 æ¬¡åŠ è½½ï¼ˆloadï¼‰
- 1 æ¬¡å­˜å‚¨ï¼ˆstoreï¼‰

å‘é‡å®½åº¦ä¸º $W$ï¼Œåˆ™æ€»å…±éœ€è¦ï¼š

- $ \frac{3N}{W} $ æ¬¡ load
- $ \frac{N}{W} $ æ¬¡ store

